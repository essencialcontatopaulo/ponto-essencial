<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Funcion√°rio - Essencial Print</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Configura√ß√£o Firebase (APENAS ARQUIVO EXTERNO) -->
    <script src="js/firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #2e7d32;
        }

        .logo h1 {
            color: #1b5e20;
            font-size: 28px;
            font-weight: 700;
        }

        .logo span {
            color: #388e3c;
            font-weight: 300;
        }

        .user-info h3 {
            color: #1b5e20;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
        }

        .btn-logout {
            background: #d32f2f;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: #b71c1c;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4caf50;
        }

        .card h2 {
            color: #1b5e20;
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c8e6c9;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #2e7d32;
            color: white;
        }

        .btn-primary:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #388e3c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .registro-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .hora-atual {
            font-size: 48px;
            font-weight: 700;
            color: #1b5e20;
            margin: 10px 0;
        }

        .data-atual {
            color: #666;
            font-size: 18px;
        }

        .ultimos-registros {
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #e8f5e8;
            color: #1b5e20;
            font-weight: 600;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-presente {
            background: #c8e6c9;
            color: #1b5e20;
        }

        .status-atrasado {
            background: #fff3cd;
            color: #856404;
        }

        .status-falta {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-top: 5px solid #4caf50;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #1b5e20;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #1b5e20;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #c8e6c9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4caf50;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        footer {
            text-align: center;
            color: white;
            padding: 20px;
            font-size: 14px;
            opacity: 0.9;
        }

        footer p:first-child {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .user-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>Essencial<span>Print</span></h1>
            </div>
            <div class="user-info">
                <h3 id="userName">Funcion√°rio</h3>
                <p id="userCargo">Painel do Funcion√°rio</p>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </header>

        <div class="dashboard">
            <!-- Registro de Ponto -->
            <div class="card">
                <h2>Registro de Ponto</h2>
                <div class="registro-info">
                    <div class="data-atual" id="dataAtual">Carregando...</div>
                    <div class="hora-atual" id="horaAtual">--:--:--</div>
                    <div style="color: #666; margin-top: 10px;" id="statusPonto">Aguardando registro</div>
                </div>
                
                <button class="btn btn-success" id="btnRegistrarEntrada" onclick="registrarPonto('entrada')">
                    Registrar Entrada
                </button>
                
                <button class="btn btn-primary" id="btnRegistrarSaida" onclick="registrarPonto('saida')" disabled>
                    Registrar Sa√≠da
                </button>
                
                <button class="btn btn-danger" onclick="abrirJustificativa()">
                    Justificar Falta/Atraso
                </button>
            </div>

            <!-- Meus Registros -->
            <div class="card">
                <h2>Meus Registros Hoje</h2>
                <div class="ultimos-registros">
                    <table id="tabelaMeusRegistros">
                        <thead>
                            <tr>
                                <th>Hor√°rio</th>
                                <th>Tipo</th>
                                <th>Localiza√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="3" style="text-align: center;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Informa√ß√µes Pessoais -->
            <div class="card">
                <h2>Minhas Informa√ß√µes</h2>
                <div id="infoPessoal">
                    <p><strong>Nome:</strong> <span id="infoNome">Carregando...</span></p>
                    <p><strong>Cargo:</strong> <span id="infoCargo">Carregando...</span></p>
                    <p><strong>Departamento:</strong> <span id="infoDepartamento">Carregando...</span></p>
                    <p><strong>CPF:</strong> <span id="infoCpf">Carregando...</span></p>
                    <p><strong>Data de Admiss√£o:</strong> <span id="infoAdmissao">Carregando...</span></p>
                </div>
            </div>
        </div>

        <!-- Hist√≥rico -->
        <div class="card" style="margin-bottom: 25px;">
            <h2>Hist√≥rico dos √öltimos 7 Dias</h2>
            <div style="max-height: 300px; overflow-y: auto;">
                <table id="tabelaHistorico">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Entrada</th>
                            <th>Sa√≠da</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align: center;">Carregando hist√≥rico...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>Essencial Print &copy; 2024 - Painel do Funcion√°rio</p>
            <p>Hor√°rio atualizado em tempo real</p>
        </footer>
    </div>

    <!-- Modal Justificativa -->
    <div id="modalJustificativa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Justificar Falta/Atraso</h3>
                <button class="close-modal" onclick="closeModal('justificativa')">√ó</button>
            </div>
            <form id="formJustificativa" onsubmit="return false;">
                <div class="form-group">
                    <label for="tipoJustificativa">Tipo *</label>
                    <select id="tipoJustificativa" class="form-control" required>
                        <option value="">Selecione...</option>
                        <option value="atraso">Atraso</option>
                        <option value="falta">Falta</option>
                        <option value="saida_antecipada">Sa√≠da Antecipada</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dataJustificativa">Data *</label>
                    <input type="date" id="dataJustificativa" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="descricaoJustificativa">Descri√ß√£o *</label>
                    <textarea id="descricaoJustificativa" class="form-control" rows="4" 
                              placeholder="Descreva o motivo da falta/atraso..." required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="enviarJustificativa()" style="flex: 1;">
                        Enviar Justificativa
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('justificativa')" style="flex: 1;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let db = null;
        let auth = null;
        let usuarioId = null;
        let usuarioDados = null;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('P√°gina do funcion√°rio carregada');
            
            // Verificar login
            const usuarioLogado = JSON.parse(localStorage.getItem('usuario_logado') || 'null');
            if (!usuarioLogado || usuarioLogado.tipo !== 'funcionario') {
                alert('Acesso restrito a funcion√°rios!');
                window.location.href = 'index.html';
                return;
            }
            
            usuarioDados = usuarioLogado;
            usuarioId = usuarioLogado.id;
            
            // Configurar dados do usu√°rio
            document.getElementById('userName').textContent = usuarioLogado.nome || 'Funcion√°rio';
            document.getElementById('userCargo').textContent = usuarioLogado.cargo || 'Funcion√°rio';
            
            // Configurar informa√ß√µes pessoais
            document.getElementById('infoNome').textContent = usuarioLogado.nome || 'N√£o informado';
            document.getElementById('infoCargo').textContent = usuarioLogado.cargo || 'N√£o informado';
            document.getElementById('infoDepartamento').textContent = usuarioLogado.departamento || 'N√£o informado';
            document.getElementById('infoCpf').textContent = usuarioLogado.cpf || 'N√£o informado';
            
            // Inicializar Firebase - C√ìDIGO CORRIGIDO
            if (typeof firebase === 'undefined') {
                console.error('Firebase n√£o carregado');
                alert('Erro: Firebase n√£o carregado. Recarregue a p√°gina.');
                return;
            }
            
            try {
                // USAR CONFIGURA√á√ÉO DO ARQUIVO EXTERNO
                const config = window.firebaseConfig || {
                    apiKey: "AIzaSyBNe8ryLTnb-IJBzR9CCmJ9Ljg_lawzTtk",
                    authDomain: "essencial-print-5a753.firebaseapp.com",
                    projectId: "essencial-print-5a753",
                    storageBucket: "essencial-print-5a753.firebasestorage.app",
                    messagingSenderId: "544082416072",
                    appId: "1:544082416072:web:85d3c8549b25158284f0fd"
                };
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                
                db = firebase.firestore();
                auth = firebase.auth();
                
                console.log('‚úÖ Firebase inicializado para funcion√°rio');
                console.log('Usu√°rio ID:', usuarioId);
                console.log('Firestore dispon√≠vel:', !!db);
                
                // Verificar autentica√ß√£o
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    console.log('Usu√°rio n√£o autenticado, usando autentica√ß√£o an√¥nima');
                } else {
                    console.log('Usu√°rio autenticado:', currentUser.email);
                }
                
                // Carregar dados
                await carregarMeusRegistrosHoje();
                await carregarHistorico();
                atualizarHora();
                await verificarStatusPonto();
                
                // Atualizar hora a cada segundo
                setInterval(atualizarHora, 1000);
                
                // Configurar data atual no modal
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('dataJustificativa').value = hoje;
                
                // Carregar dados completos do Firestore
                await carregarDadosCompletos();
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Firebase:', error);
                alert('Erro ao conectar com o servidor: ' + error.message);
            }
        });
        
        // Fun√ß√µes
        function atualizarHora() {
            const agora = new Date();
            const dataFormatada = agora.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const horaFormatada = agora.toLocaleTimeString('pt-BR');
            
            document.getElementById('dataAtual').textContent = dataFormatada;
            document.getElementById('horaAtual').textContent = horaFormatada;
        }
        
        async function carregarDadosCompletos() {
            if (!db || !usuarioId) return;
            
            try {
                const userDoc = await db.collection('usuarios').doc(usuarioId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Atualizar informa√ß√µes pessoais
                    if (userData.dataAdmissao) {
                        const dataAdmissao = new Date(userData.dataAdmissao).toLocaleDateString('pt-BR');
                        document.getElementById('infoAdmissao').textContent = dataAdmissao;
                    }
                    
                    if (userData.salario) {
                        const infoDiv = document.getElementById('infoPessoal');
                        infoDiv.innerHTML += `<p><strong>Sal√°rio:</strong> R$ ${userData.salario.toFixed(2)}</p>`;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados completos:', error);
            }
        }
        
        async function carregarMeusRegistrosHoje() {
            if (!db || !usuarioId) {
                console.log('Firestore ou usu√°rio n√£o dispon√≠vel');
                return;
            }
            
            try {
                const hoje = new Date().toISOString().split('T')[0];
                console.log('Buscando registros para:', hoje, 'usu√°rio:', usuarioId);
                
                const snapshot = await db.collection('pontos')
                    .where('funcionarioId', '==', usuarioId)
                    .where('data', '==', hoje)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                console.log('Registros encontrados:', snapshot.size);
                
                const tbody = document.querySelector('#tabelaMeusRegistros tbody');
                let html = '';
                
                if (snapshot.empty) {
                    html = '<tr><td colspan="3" style="text-align: center;">Nenhum registro hoje</td></tr>';
                } else {
                    snapshot.forEach(doc => {
                        const reg = doc.data();
                        console.log('Registro encontrado:', reg);
                        html += `
                            <tr>
                                <td>${reg.horario}</td>
                                <td>${reg.tipo === 'entrada' ? 'Entrada' : 'Sa√≠da'}</td>
                                <td>${reg.localizacao?.latitude ? 'üìç' : '--'}</td>
                            </tr>
                        `;
                    });
                }
                
                tbody.innerHTML = html;
                
            } catch (error) {
                console.error('Erro ao carregar registros:', error);
            }
        }
        
        async function verificarStatusPonto() {
            if (!db || !usuarioId) return;
            
            try {
                const hoje = new Date().toISOString().split('T')[0];
                const snapshot = await db.collection('pontos')
                    .where('funcionarioId', '==', usuarioId)
                    .where('data', '==', hoje)
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                const btnEntrada = document.getElementById('btnRegistrarEntrada');
                const btnSaida = document.getElementById('btnRegistrarSaida');
                const statusPonto = document.getElementById('statusPonto');
                
                if (snapshot.empty) {
                    // N√£o registrou entrada hoje
                    btnEntrada.disabled = false;
                    btnSaida.disabled = true;
                    statusPonto.textContent = 'Aguardando entrada';
                    statusPonto.style.color = '#666';
                } else {
                    const ultimoRegistro = snapshot.docs[0].data();
                    
                    if (ultimoRegistro.tipo === 'entrada') {
                        // Registrou entrada, pode registrar sa√≠da
                        btnEntrada.disabled = true;
                        btnSaida.disabled = false;
                        statusPonto.textContent = `Entrada registrada √†s ${ultimoRegistro.horario}`;
                        statusPonto.style.color = '#4caf50';
                    } else {
                        // J√° registrou sa√≠da hoje
                        btnEntrada.disabled = true;
                        btnSaida.disabled = true;
                        statusPonto.textContent = `Sa√≠da registrada √†s ${ultimoRegistro.horario}`;
                        statusPonto.style.color = '#2e7d32';
                    }
                }
                
            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }
        
        async function registrarPonto(tipo) {
            console.log('=== INICIANDO REGISTRO DE PONTO ===');
            console.log('Tipo:', tipo);
            console.log('DB dispon√≠vel?', !!db);
            console.log('Usu√°rio ID:', usuarioId);
            
            if (!db || !usuarioId) {
                console.error('DB ou usu√°rio n√£o dispon√≠vel');
                alert('Erro: Sistema n√£o dispon√≠vel. DB ou usu√°rio n√£o carregado.');
                return;
            }
            
            try {
                const agora = new Date();
                const data = agora.toISOString().split('T')[0];
                const horario = agora.toLocaleTimeString('pt-BR', { hour12: false });
                
                console.log('Data:', data);
                console.log('Hor√°rio:', horario);
                
                // Obter localiza√ß√£o (se permitido)
                let localizacao = { latitude: null, longitude: null };
                
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                timeout: 5000,
                                maximumAge: 0
                            });
                        });
                        
                        localizacao = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            precisao: position.coords.accuracy
                        };
                        console.log('Localiza√ß√£o obtida:', localizacao);
                    } catch (geoError) {
                        console.warn('N√£o foi poss√≠vel obter localiza√ß√£o:', geoError.message);
                    }
                }
                
                console.log('Salvando ponto no Firestore...');
                
                // Dados a serem salvos
                const pontoData = {
                    funcionarioId: usuarioId,
                    funcionarioNome: usuarioDados.nome || 'Funcion√°rio',
                    tipo: tipo,
                    horario: horario,
                    data: data,
                    timestamp: agora.getTime(),
                    localizacao: localizacao,
                    metodo: 'web',
                    dataRegistro: agora.toISOString()
                };
                
                console.log('Dados do ponto:', pontoData);
                
                // Salvar no Firestore
                const docRef = await db.collection('pontos').add(pontoData);
                console.log('‚úÖ Ponto salvo com ID:', docRef.id);
                
                alert(`‚úÖ ${tipo === 'entrada' ? 'Entrada' : 'Sa√≠da'} registrada com sucesso!`);
                
                // Atualizar interface
                await carregarMeusRegistrosHoje();
                await verificarStatusPonto();
                await carregarHistorico();
                
                console.log('=== REGISTRO CONCLU√çDO ===');
                
            } catch (error) {
                console.error('‚ùå Erro ao registrar ponto:', error);
                console.error('C√≥digo do erro:', error.code);
                console.error('Mensagem completa:', error.message);
                
                let errorMessage = 'Erro ao registrar ponto: ' + error.message;
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permiss√£o negada. Configure as regras do Firestore para permitir escrita.';
                } else if (error.code === 'failed-precondition') {
                    errorMessage = 'Firestore n√£o est√° configurado corretamente.';
                }
                
                alert(errorMessage);
            }
        }
        
        function abrirJustificativa() {
            document.getElementById('modalJustificativa').style.display = 'flex';
        }
        
        function closeModal(modalName) {
            document.getElementById(`modal${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`).style.display = 'none';
        }
        
        async function enviarJustificativa() {
            if (!db || !usuarioId) {
                alert('Erro: Sistema n√£o dispon√≠vel');
                return;
            }
            
            const tipo = document.getElementById('tipoJustificativa').value;
            const data = document.getElementById('dataJustificativa').value;
            const descricao = document.getElementById('descricaoJustificativa').value.trim();
            
            if (!tipo || !data || !descricao) {
                alert('Preencha todos os campos!');
                return;
            }
            
            try {
                await db.collection('justificativas').add({
                    funcionarioId: usuarioId,
                    funcionarioNome: usuarioDados.nome || 'Funcion√°rio',
                    tipo: tipo,
                    data: data,
                    descricao: descricao,
                    status: 'pendente',
                    dataEnvio: new Date().toISOString()
                });
                
                alert('‚úÖ Justificativa enviada com sucesso!');
                closeModal('justificativa');
                document.getElementById('formJustificativa').reset();
                
            } catch (error) {
                console.error('Erro ao enviar justificativa:', error);
                alert('Erro ao enviar justificativa: ' + error.message);
            }
        }
        
        async function carregarHistorico() {
            if (!db || !usuarioId) return;
            
            try {
                const seteDiasAtras = new Date();
                seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);
                const dataInicio = seteDiasAtras.toISOString().split('T')[0];
                
                const snapshot = await db.collection('pontos')
                    .where('funcionarioId', '==', usuarioId)
                    .where('data', '>=', dataInicio)
                    .orderBy('data', 'desc')
                    .get();
                
                // Agrupar por data
                const registrosPorData = {};
                snapshot.forEach(doc => {
                    const reg = doc.data();
                    if (!registrosPorData[reg.data]) {
                        registrosPorData[reg.data] = { entrada: null, saida: null };
                    }
                    
                    if (reg.tipo === 'entrada') {
                        registrosPorData[reg.data].entrada = reg.horario;
                    } else if (reg.tipo === 'saida') {
                        registrosPorData[reg.data].saida = reg.horario;
                    }
                });
                
                // Gerar tabela
                const tbody = document.querySelector('#tabelaHistorico tbody');
                let html = '';
                
                const datas = Object.keys(registrosPorData).sort().reverse();
                
                if (datas.length === 0) {
                    html = '<tr><td colspan="5" style="text-align: center;">Nenhum registro nos √∫ltimos 7 dias</td></tr>';
                } else {
                    datas.forEach(data => {
                        const registros = registrosPorData[data];
                        const dataBR = new Date(data).toLocaleDateString('pt-BR');
                        const entrada = registros.entrada || '--:--';
                        const saida = registros.saida || '--:--';
                        
                        // Calcular horas trabalhadas
                        let total = '--';
                        if (registros.entrada && registros.saida) {
                            const [h1, m1] = registros.entrada.split(':').map(Number);
                            const [h2, m2] = registros.saida.split(':').map(Number);
                            const minutos = (h2 * 60 + m2) - (h1 * 60 + m1);
                            const horas = Math.floor(minutos / 60);
                            const mins = minutos % 60;
                            total = `${horas}:${mins.toString().padStart(2, '0')}`;
                        }
                        
                        // Determinar status
                        let status = 'Completo';
                        let statusClass = 'status-presente';
                        
                        if (!registros.entrada && !registros.saida) {
                            status = 'Falta';
                            statusClass = 'status-falta';
                        } else if (registros.entrada && !registros.saida) {
                            status = 'Pendente';
                            statusClass = 'status-atrasado';
                        }
                        
                        html += `
                            <tr>
                                <td>${dataBR}</td>
                                <td>${entrada}</td>
                                <td>${saida}</td>
                                <td>${total}h</td>
                                <td><span class="status-badge ${statusClass}">${status}</span></td>
                            </tr>
                        `;
                    });
                }
                
                tbody.innerHTML = html;
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }
        
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('usuario_logado');
                if (auth) {
                    auth.signOut();
                }
                window.location.href = 'index.html';
            }
        }
        
        // TESTE DE FUNCIONAMENTO (tempor√°rio)
        async function testarFirestore() {
            try {
                console.log('=== TESTE FIRESTORE ===');
                
                if (!db) {
                    console.error('Firestore n√£o inicializado');
                    alert('Firestore n√£o inicializado');
                    return;
                }
                
                // Teste: Criar documento de teste
                const testData = {
                    teste: 'funcionando',
                    timestamp: new Date().toISOString(),
                    usuario: usuarioId
                };
                
                const docRef = await db.collection('testes').add(testData);
                console.log('‚úÖ Documento criado com ID:', docRef.id);
                alert('‚úÖ Firestore funcionando! ID: ' + docRef.id);
                
                // Teste: Verificar cole√ß√£o pontos
                const snapshot = await db.collection('pontos')
                    .where('funcionarioId', '==', usuarioId)
                    .limit(1)
                    .get();
                
                console.log('Registros na cole√ß√£o "pontos":', snapshot.size);
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                alert('‚ùå Erro: ' + error.message);
            }
        }
        
        // Adicionar bot√£o de teste tempor√°rio (remova depois)
        setTimeout(() => {
            const testBtn = document.createElement('button');
            testBtn.textContent = 'üîß TESTAR FIRESTORE';
            testBtn.style.cssText = 'position: fixed; bottom: 10px; right: 10px; background: orange; color: white; padding: 10px; border-radius: 5px; z-index: 9999;';
            testBtn.onclick = testarFirestore;
            document.body.appendChild(testBtn);
        }, 2000);
        
        // Exportar fun√ß√µes para uso global
        window.registrarPonto = registrarPonto;
        window.abrirJustificativa = abrirJustificativa;
        window.closeModal = closeModal;
        window.enviarJustificativa = enviarJustificativa;
        window.logout = logout;
    </script>
</body>
</html>
